# ?? GUIDE COMPLET - Docker Check Script pour Kafka Producer API

## ?? Présentation du Script

Ce guide explique comment utiliser le script PowerShell **`Full-Docker-Check.ps1`** pour tester complètement votre API Kafka Producer dans Docker.

---

## ? Prérequis

Avant de commencer, assurez-vous d'avoir:

```powershell
# 1. .NET 8.0 SDK
dotnet --version
# Doit afficher: 8.0.x

# 2. Docker Desktop
docker --version
# Doit afficher: Docker version 24.x.x

# 3. PowerShell (Windows)
$PSVersionTable.PSVersion
# Doit afficher: Version 5.1+
```

---

## ?? Utilisation Rapide

### Étape 1: Naviguer au Projet

```powershell
cd "D:\Data2AI Academy\Kafka\kafka-bhf\formation-v2\day-01-foundations\module-02-producer-reliability\kafka_producer"
```

### Étape 2: Exécuter le Script

```powershell
# Lancement complet (Build + Test)
.\Full-Docker-Check.ps1

# OU avec options
.\Full-Docker-Check.ps1 -SkipBuild              # Sauter le build
.\Full-Docker-Check.ps1 -Verbose                # Mode verbose
.\Full-Docker-Check.ps1 -SkipBuild -Verbose    # Combinaison
```

### Étape 3: Consulter le Rapport

Le script génère un rapport dans un fichier:
```
Docker-Check-Report-YYYY-MM-DD_HH-MM-SS.txt
```

---

## ?? Structure du Script

### PHASE 1: Vérification des Prérequis

```
? Vérification de Program.cs
? Vérification de .NET SDK
? Vérification de Docker
? Vérification du daemon Docker
```

### PHASE 2: Build de l'Image Docker

```
? Suppression de l'image existante
? Construction de la nouvelle image
? Vérification de l'image
```

### PHASE 3: Lancement du Conteneur

```
? Nettoyage des conteneurs existants
? Lancement du nouveau conteneur
? Attente du démarrage (10s)
? Vérification de l'état
```

### PHASE 4: Tests de l'API

```
? Test 1: Health Check (HTTP)
? Test 2: Health Check (HTTPS)
? Test 3: Swagger UI
? Test 4: Ports Disponibles
? Test 5: Logs du Conteneur
? Test 6: Ressources Utilisées
```

### PHASE 5: Tests Avancés

```
? Test 7: Response Headers
? Test 8: Performance (Latency)
```

### PHASE 6-7: Rapport Final & Commandes Utiles

```
? Statistiques détaillées
? Tableau des résultats
? Verdict final
? Commandes utiles
```

---

## ?? Résultats Attendus

### Exemple de Sortie Réussie

```
?????????????????????????????????????????????????????????????????????
?  KAFKA PRODUCER - DOCKER CHECK COMPLET                           ?
?????????????????????????????????????????????????????????????????????

Timestamp: 2024-01-15 14:30:45
Project Path: D:\path\to\kafka_producer

???????????????????????????????????????????????????????
  PHASE 1: Vérification des Prérequis
???????????????????????????????????????????????????????

  ? Program.cs trouvé
  ? .NET SDK installé: 8.0.100
  ? Docker installé: Docker version 24.0.0
  ? Docker daemon est en cours d'exécution

[... Phases 2-5 ...]

???????????????????????????????????????????????????????
  RÉSUMÉ DES TESTS
???????????????????????????????????????????????????????

?? Statistiques:
   Total des tests: 8
   ? Réussis: 8
   ? Échoués: 0
   ??  Avertissements: 0
   ??  Ignorés: 0

?? VERDICT FINAL:
   ? TOUS LES TESTS RÉUSSIS!
   ?? L'API DOCKER FONCTIONNE CORRECTEMENT
```

---

## ?? Options du Script

### Option: -SkipBuild

Saute l'étape de compilation de l'image Docker. Utile si:
- L'image est déjà construite
- Vous testez plusieurs fois
- Vous n'avez pas changé le code

```powershell
.\Full-Docker-Check.ps1 -SkipBuild
```

### Option: -SkipPull

Saute le pull de l'image de base. Utile si:
- Vous avez déjà l'image
- Vous êtes hors ligne (offline)

```powershell
.\Full-Docker-Check.ps1 -SkipPull
```

### Option: -Verbose

Affiche les logs détaillés du conteneur.

```powershell
.\Full-Docker-Check.ps1 -Verbose
```

---

## ?? Tests Effectués

### Test 1: Health Check (HTTP)
```
Endpoint: GET http://localhost:5000/health
Vérifie que l'API répond sur le port HTTP standard
Résultat attendu: 200 OK avec "OK" en réponse
```

### Test 2: Health Check (HTTPS)
```
Endpoint: GET https://localhost:5001/health
Vérifie que HTTPS fonctionne
Résultat attendu: 200 OK avec "OK" en réponse
```

### Test 3: Swagger UI
```
Endpoint: GET https://localhost:5001/swagger/ui/index.html
Vérifie l'interface Swagger
Résultat attendu: 200 OK avec HTML Swagger
```

### Test 4: Port Availability
```
Commande: netstat -ano
Vérifie que les ports 5000/5001 écoutent
```

### Test 5: Container Logs
```
Commande: docker logs
Vérifie que l'application a démarré correctement
```

### Test 6: Container Stats
```
Commande: docker stats
Affiche l'utilisation CPU et mémoire
```

### Test 7: Response Headers
```
Vérifie les headers HTTP de réponse
Server, Date, Content-Type, Connection
```

### Test 8: Latency Test
```
Effectue 5 requêtes consécutives
Calcule la latence moyenne
Vérifie les performances
```

---

## ?? Résolution des Problèmes

### ? Erreur: "Docker n'est pas installé"

**Solution:**
1. Installez Docker Desktop
2. Redémarrez votre ordinateur
3. Relancez PowerShell

```powershell
# Vérifier:
docker --version
```

### ? Erreur: "Docker daemon n'est pas en cours d'exécution"

**Solution:**
1. Lancez Docker Desktop
2. Attendez que Docker se charge complètement (~30s)
3. Relancez le script

```powershell
# Vérifier:
docker ps
```

### ? Erreur: "Build échoué"

**Solution:**
1. Vérifiez le fichier `Dockerfile`
2. Assurez-vous que tous les fichiers existent
3. Nettoyez le cache Docker

```powershell
# Nettoyer le cache:
docker system prune -a

# Relancer:
.\Full-Docker-Check.ps1
```

### ? Erreur: "Health Check échoué"

**Solution:**
1. Vérifiez les logs du conteneur
2. Attendez quelques secondes supplémentaires
3. Redémarrez le conteneur

```powershell
# Voir les logs:
docker logs kafka-producer-test

# Redémarrer:
docker restart kafka-producer-test
```

### ? Erreur: "Port 5000/5001 déjà utilisé"

**Solution:**
```powershell
# Trouver le processus:
netstat -ano | findstr "5000|5001"

# Tuer le processus (example PID 1234):
taskkill /PID 1234 /F

# OU arrêter tous les conteneurs:
docker stop $(docker ps -q)
```

---

## ?? Commandes Utiles Pendant le Test

### Monitorer l'API en Direct

```powershell
# Voir les logs en temps réel:
docker logs -f kafka-producer-test

# Voir les stats en temps réel:
docker stats kafka-producer-test

# Accéder au shell du conteneur:
docker exec -it kafka-producer-test /bin/sh
```

### Tester Manuellement

```powershell
# Health Check:
curl http://localhost:5000/health

# Swagger UI:
Start-Process https://localhost:5001/swagger/ui/index.html

# Avec PowerShell:
Invoke-WebRequest -Uri http://localhost:5000/health
```

### Gestion du Conteneur

```powershell
# Arrêter:
docker stop kafka-producer-test

# Supprimer:
docker rm kafka-producer-test

# Redémarrer:
docker restart kafka-producer-test

# Inspecter:
docker inspect kafka-producer-test
```

---

## ?? Workflow Complet

### Première Utilisation

```powershell
# 1. Naviguer au projet
cd kafka_producer

# 2. Exécuter le script complet
.\Full-Docker-Check.ps1

# 3. Attendre les résultats (~2-3 minutes)

# 4. Consulter le rapport généré
notepad "Docker-Check-Report-*.txt"

# 5. Accéder à l'API
Start-Process https://localhost:5001/swagger/ui/index.html
```

### Développement Continu

```powershell
# Après chaque modification:

# 1. Relancer le script (avec skip build pour plus rapide)
.\Full-Docker-Check.ps1 -SkipBuild

# 2. Vérifier les logs
docker logs -f kafka-producer-test

# 3. Tester les endpoints
curl http://localhost:5000/health
```

### Avant le Déploiement

```powershell
# 1. Nettoyage complet
docker system prune -a

# 2. Build frais
.\Full-Docker-Check.ps1

# 3. Tous les tests doivent passer
# 4. Consulter le rapport final
```

---

## ?? Fichiers Générés

### Rapport de Vérification

Chaque exécution génère:
```
Docker-Check-Report-2024-01-15_14-30-45.txt
```

Ce fichier contient:
- Timestamp complet
- Statistiques des tests
- Détails de chaque test
- Configuration Docker
- Verdict final

### Logs du Conteneur

Accessibles via:
```powershell
docker logs kafka-producer-test
```

---

## ?? Exemple de Sortie Complète

```
?????????????????????????????????????????????????????????????????????
?  KAFKA PRODUCER - DOCKER CHECK COMPLET                           ?
?????????????????????????????????????????????????????????????????????

Timestamp: 2024-01-15 14:30:45
Project Path: D:\kafka_producer

???????????????????????????????????????????????????????
  PHASE 1: Vérification des Prérequis
???????????????????????????????????????????????????????
  ? Program.cs trouvé
  ? .NET SDK installé: 8.0.100
  ? Docker installé: Docker version 24.0.0, build abc1234
  ? Docker daemon est en cours d'exécution

???????????????????????????????????????????????????????
  PHASE 2: Build de l'Image Docker
???????????????????????????????????????????????????????
  ??  Suppression de l'image existante...
  ? Image Docker construite avec succès
  ??  Image: kafka-producer:latest
  ? Image Docker vérifiée

???????????????????????????????????????????????????????
  PHASE 3: Lancement du Conteneur Docker
???????????????????????????????????????????????????????
  ??  Lancement du conteneur...
  ? Conteneur lancé avec succès
  ??  Container ID: abc123def456xyz
  ??  Attente du démarrage de l'application (10 secondes)...
  ? Conteneur en cours d'exécution

???????????????????????????????????????????????????????
  PHASE 4: Tests de l'API
???????????????????????????????????????????????????????
  ??  TEST 1: Health Check (HTTP)...
  ? Health Check réussi (HTTP)
  ??    Status: 200
  ??    Response: OK
  
  ??  TEST 2: Health Check (HTTPS)...
  ? Health Check réussi (HTTPS)
  ??    Status: 200
  ??    Response: OK
  
  ??  TEST 3: Swagger UI...
  ? Swagger UI accessible
  ??    Status: 200
  ??    URL: https://localhost:5001/swagger/ui/index.html
  
  ??  TEST 4: Vérification des Ports...
  ? Ports 5000 et 5001 écoutent
  
  ??  TEST 5: Vérification des Logs du Conteneur...
  ? Logs du conteneur normaux
  
  ??  TEST 6: Ressources du Conteneur...
  ? Conteneur en cours d'exécution

???????????????????????????????????????????????????????
  PHASE 5: Tests Avancés
???????????????????????????????????????????????????????
  ??  TEST 7: Response Headers...
  ? Response headers OK
  ??    Server: Kestrel
  ??    Date: Mon, 15 Jan 2024 14:30:55 GMT
  ??    Content-Type: text/plain; charset=utf-8
  ??    Connection: keep-alive
  
  ??  TEST 8: Latency Test...
  ? Latency Test complet
  ??    Iterations: 5
  ??    Latency moyenne: 12.34ms
  ? Performance excellente!

???????????????????????????????????????????????????????
  RÉSUMÉ DES TESTS
???????????????????????????????????????????????????????

?? Statistiques:
   Total des tests: 8
   ? Réussis: 8
   ? Échoués: 0
   ??  Avertissements: 0
   ??  Ignorés: 0

?? Détails des Tests:
????????????????????????????????????????????????????????????
? Nom du Test                    ? Status   ? Détails      ?
????????????????????????????????????????????????????????????
? Fichier Program.cs             ? ? PASS  ?              ?
? Docker                         ? ? PASS  ? Docker 24... ?
? Docker Daemon                  ? ? PASS  ?              ?
? Docker Build                   ? ? PASS  ?              ?
? Container Startup              ? ? PASS  ? abc123de...  ?
? Container Status               ? ? PASS  ?              ?
? Health Check (HTTP)            ? ? PASS  ?              ?
? Health Check (HTTPS)           ? ? PASS  ?              ?
????????????????????????????????????????????????????????????

?? VERDICT FINAL:
   ? TOUS LES TESTS RÉUSSIS!
   ?? L'API DOCKER FONCTIONNE CORRECTEMENT

???????????????????????????????????????????????????????
  COMMANDES UTILES
???????????????????????????????????????????????????????

?? Gestion du Conteneur:
   Logs en direct:
   > docker logs -f kafka-producer-test
   
   Arrêter le conteneur:
   > docker stop kafka-producer-test
   
   Supprimer le conteneur:
   > docker rm kafka-producer-test

?? Accès à l'API:
   Health Check (HTTP):
   > http://localhost:5000/health
   
   Swagger UI (HTTPS):
   > https://localhost:5001/swagger/ui/index.html

? VÉRIFICATION DOCKER COMPLÉTÉE
```

---

## ?? Résumé

Le script **`Full-Docker-Check.ps1`** automatise entièrement la vérification Docker de votre API Kafka Producer :

? Vérifie les prérequis  
? Construit l'image Docker  
? Lance le conteneur  
? Effectue 8 tests différents  
? Génère un rapport détaillé  
? Fournit les commandes utiles  

**Exécution simple:**
```powershell
.\Full-Docker-Check.ps1
```

**Status:** ?? **PRÊT POUR LA PRODUCTION**

