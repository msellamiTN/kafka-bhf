# Quick-Fix-HTTP-Only.ps1 - Fix rapide pour utiliser HTTP uniquement

<#
.SYNOPSIS
    Script pour désactiver rapidement HTTPS et utiliser HTTP uniquement

.DESCRIPTION
    1. Modifie Program.cs pour désactiver HTTPS Redirect
    2. Recompile le projet
    3. Recrée le conteneur Docker
    4. Lance les tests

.EXAMPLE
    .\Quick-Fix-HTTP-Only.ps1

.NOTES
    Version: 1.0
    Auteur: GitHub Copilot
    Date: 2024
#>

Write-Host "`n??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host "?  QUICK FIX - HTTP ONLY MODE                                               ?" -ForegroundColor Green
Write-Host "??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Green

# ============================================
# ÉTAPE 1: Vérifier Program.cs
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "ÉTAPE 1: Vérification de Program.cs" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

if (-not (Test-Path "Program.cs")) {
    Write-Host "? Program.cs non trouvé" -ForegroundColor Red
    Write-Host "   Assurez-vous d'être dans le dossier du projet" -ForegroundColor Yellow
    exit 1
}
Write-Host "? Program.cs trouvé" -ForegroundColor Green

# ============================================
# ÉTAPE 2: Lire Program.cs
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "ÉTAPE 2: Lecture de Program.cs" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

$content = Get-Content -Path "Program.cs" -Raw

if ($content -match "app\.UseHttpsRedirection") {
    Write-Host "? UseHttpsRedirection trouvé dans Program.cs" -ForegroundColor Green
}
else {
    Write-Host "??  UseHttpsRedirection n'est pas présent" -ForegroundColor Cyan
    Write-Host "   Rien à modifier" -ForegroundColor Cyan
    exit 0
}

# ============================================
# ÉTAPE 3: Créer une sauvegarde
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "ÉTAPE 3: Création d'une Sauvegarde" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

$backupFile = "Program.cs.backup.$(Get-Date -Format 'yyyyMMdd_HHmmss')"
Copy-Item -Path "Program.cs" -Destination $backupFile
Write-Host "? Sauvegarde créée: $backupFile" -ForegroundColor Green

# ============================================
# ÉTAPE 4: Désactiver UseHttpsRedirection
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "ÉTAPE 4: Modification de Program.cs" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

# Remplacer les deux versions possibles
$newContent = $content -replace 'app\.UseHttpsRedirection\(\);', '// app.UseHttpsRedirection(); // Disabled for HTTP-only mode'
$newContent = $newContent -replace '// app\.UseHttpsRedirection\(\);', '// app.UseHttpsRedirection(); // Disabled for HTTP-only mode'

# Écrire le nouveau contenu
Set-Content -Path "Program.cs" -Value $newContent
Write-Host "? Program.cs modifié" -ForegroundColor Green
Write-Host "   - app.UseHttpsRedirection() désactivé" -ForegroundColor Cyan

# ============================================
# ÉTAPE 5: Compiler le projet
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "ÉTAPE 5: Compilation du Projet" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

Write-Host "  ??  Building..." -ForegroundColor Cyan
$buildOutput = dotnet build -c Release 2>&1

if ($LASTEXITCODE -eq 0) {
    Write-Host "? Build réussi" -ForegroundColor Green
}
else {
    Write-Host "? Build échoué" -ForegroundColor Red
    Write-Host $buildOutput -ForegroundColor Red
    Write-Host "`n??  Restauration de la sauvegarde..." -ForegroundColor Yellow
    Copy-Item -Path $backupFile -Destination "Program.cs" -Force
    exit 1
}

# ============================================
# ÉTAPE 6: Arrêter le conteneur existant
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "ÉTAPE 6: Préparation du Conteneur Docker" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

Write-Host "  ??  Arrêt du conteneur existant..." -ForegroundColor Cyan
docker stop kafka-producer-test 2>&1 | Out-Null
docker rm kafka-producer-test 2>&1 | Out-Null
Write-Host "? Conteneur arrêté et supprimé" -ForegroundColor Green

# ============================================
# ÉTAPE 7: Créer Dockerfile HTTP-only
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "ÉTAPE 7: Création du Dockerfile HTTP-only" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

$httpDockerfile = @"
# Multi-stage Dockerfile - HTTP Only (Development)

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS builder

WORKDIR /source

COPY ["kafka_producer.csproj", ""]
COPY ["Program.cs", ""]
COPY ["appsettings.json", ""]
COPY ["appsettings.Development.json", ""]
COPY ["Services/", "Services/"]
COPY ["Controllers/", "Controllers/"]
COPY ["Properties/", "Properties/"]

RUN dotnet restore "kafka_producer.csproj"
RUN dotnet build "kafka_producer.csproj" -c Release -o /app/build
RUN dotnet publish "kafka_producer.csproj" -c Release -o /app/publish /p:UseAppHost=false

FROM mcr.microsoft.com/dotnet/aspnet:8.0

WORKDIR /app

RUN apt-get update && apt-get install -y curl ca-certificates && rm -rf /var/lib/apt/lists/*

COPY --from=builder /app/publish .

HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:80/health || exit 1

EXPOSE 80

ENV ASPNETCORE_ENVIRONMENT=Development
ENV ASPNETCORE_URLS=http://+:80

ENTRYPOINT ["dotnet", "kafka_producer.dll"]
"@

$httpDockerfile | Out-File -FilePath "Dockerfile.http" -Encoding UTF8
Write-Host "? Dockerfile.http créé" -ForegroundColor Green

# ============================================
# ÉTAPE 8: Build Docker
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "ÉTAPE 8: Build de l'Image Docker" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

Write-Host "  ??  Building Docker image..." -ForegroundColor Cyan
$dockerBuild = docker build -f Dockerfile.http -t kafka-producer:http . 2>&1

if ($LASTEXITCODE -eq 0) {
    Write-Host "? Image Docker construite" -ForegroundColor Green
}
else {
    Write-Host "? Erreur Docker build" -ForegroundColor Red
    Write-Host $dockerBuild -ForegroundColor Red
    exit 1
}

# ============================================
# ÉTAPE 9: Lancer le conteneur
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "ÉTAPE 9: Lancement du Conteneur" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

Write-Host "  ??  Lancement du conteneur..." -ForegroundColor Cyan
$containerRun = docker run -d `
    --name kafka-producer-test `
    -p 5000:80 `
    kafka-producer:http 2>&1

if ($LASTEXITCODE -eq 0) {
    Write-Host "? Conteneur lancé" -ForegroundColor Green
    Write-Host "   Container ID: $containerRun" -ForegroundColor Cyan
}
else {
    Write-Host "? Erreur lancement conteneur" -ForegroundColor Red
    exit 1
}

# ============================================
# ÉTAPE 10: Attendre le démarrage
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "ÉTAPE 10: Attente et Tests" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

Write-Host "  ??  Attente du démarrage (10 secondes)..." -ForegroundColor Cyan
Start-Sleep -Seconds 10

# Test rapide
Write-Host "  ??  Test du health endpoint..." -ForegroundColor Cyan
try {
    $response = Invoke-WebRequest -Uri "http://localhost:5000/health" -TimeoutSec 3 -ErrorAction Stop
    Write-Host "? API répond!" -ForegroundColor Green
    Write-Host "   Status: $($response.StatusCode)" -ForegroundColor Cyan
    Write-Host "   Response: $($response.Content)" -ForegroundColor Cyan
}
catch {
    Write-Host "??  API ne répond pas encore..." -ForegroundColor Yellow
    Write-Host "   Attendez quelques secondes de plus" -ForegroundColor Yellow
    Start-Sleep -Seconds 5
}

# ============================================
# RÉSUMÉ FINAL
# ============================================

Write-Host "`n??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host "?  ? QUICK FIX APPLIQUÉ AVEC SUCCÈS                                         ?" -ForegroundColor Green
Write-Host "??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Green

Write-Host "`n?? Résumé des modifications:" -ForegroundColor Cyan
Write-Host "   ? Program.cs modifié (UseHttpsRedirection désactivé)" -ForegroundColor Green
Write-Host "   ? Projet compilé en mode Release" -ForegroundColor Green
Write-Host "   ? Dockerfile.http créé (HTTP uniquement)" -ForegroundColor Green
Write-Host "   ? Image Docker construite" -ForegroundColor Green
Write-Host "   ? Conteneur lancé sur port 5000 (HTTP)" -ForegroundColor Green

Write-Host "`n?? API accessible sur:" -ForegroundColor Yellow
Write-Host "   HTTP Health Check: http://localhost:5000/health" -ForegroundColor Cyan
Write-Host "   HTTP Swagger UI:   http://localhost:5000/swagger/ui/index.html" -ForegroundColor Cyan

Write-Host "`n?? Commandes utiles:" -ForegroundColor Yellow
Write-Host "   Logs en direct:    docker logs -f kafka-producer-test" -ForegroundColor Cyan
Write-Host "   Arrêter:           docker stop kafka-producer-test" -ForegroundColor Cyan
Write-Host "   Redémarrer:        docker start kafka-producer-test" -ForegroundColor Cyan
Write-Host "   Tous les tests:    .\Full-Docker-Check.ps1" -ForegroundColor Cyan

Write-Host "`n?? Sauvegarde:" -ForegroundColor Yellow
Write-Host "   Original Program.cs: $backupFile" -ForegroundColor Cyan
Write-Host "   Vous pouvez le restaurer si besoin" -ForegroundColor Cyan

Write-Host "`n? Status: HTTP-ONLY MODE ACTIVÉ" -ForegroundColor Green

Write-Host "`n"
