services:
  toxiproxy:
    image: ghcr.io/shopify/toxiproxy:2.9.0
    container_name: toxiproxy
    ports:
      - "8474:8474"
      - "29093:29093"
    networks:
      - bhf-kafka-network
    healthcheck:
      test: ["CMD", "/toxiproxy-cli", "list"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  toxiproxy-init:
    image: curlimages/curl:8.5.0
    container_name: toxiproxy-init
    depends_on:
      toxiproxy:
        condition: service_healthy
    command: >
      sh -c "curl -fsS -X POST http://toxiproxy:8474/proxies -H 'Content-Type: application/json' -d '{\"name\":\"kafka\",\"listen\":\"0.0.0.0:29093\",\"upstream\":\"kafka:29092\"}' && echo ' Proxy created successfully'"
    networks:
      - bhf-kafka-network

  java-api:
    build:
      context: ./java
    container_name: m02-java-api
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      SERVER_PORT: 8080
      KAFKA_REQUEST_TIMEOUT_MS: ${KAFKA_REQUEST_TIMEOUT_MS:-30000}
      KAFKA_DELIVERY_TIMEOUT_MS: ${KAFKA_DELIVERY_TIMEOUT_MS:-120000}
      KAFKA_RETRY_BACKOFF_MS: ${KAFKA_RETRY_BACKOFF_MS:-100}
      KAFKA_RETRIES: ${KAFKA_RETRIES:-3}
      KAFKA_LINGER_MS: ${KAFKA_LINGER_MS:-0}
      KAFKA_ACKS_PLAIN: ${KAFKA_ACKS_PLAIN:-1}
    ports:
      - "18080:8080"
    networks:
      - bhf-kafka-network

  dotnet-api:
    build:
      context: ./dotnet
    container_name: m02-dotnet-api
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      ASPNETCORE_URLS: http://0.0.0.0:8080
      KAFKA_REQUEST_TIMEOUT_MS: ${KAFKA_REQUEST_TIMEOUT_MS:-30000}
      KAFKA_DELIVERY_TIMEOUT_MS: ${KAFKA_DELIVERY_TIMEOUT_MS:-120000}
      KAFKA_RETRY_BACKOFF_MS: ${KAFKA_RETRY_BACKOFF_MS:-100}
      KAFKA_RETRIES: ${KAFKA_RETRIES:-3}
      KAFKA_LINGER_MS: ${KAFKA_LINGER_MS:-0}
    ports:
      - "18081:8080"
    networks:
      - bhf-kafka-network

networks:
  bhf-kafka-network:
    external: true
