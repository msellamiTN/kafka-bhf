# Diagnose-HTTPS-Issue.ps1 - Diagnostic et Solution pour HTTPS Docker

<#
.SYNOPSIS
    Script de diagnostic et solution pour les problèmes HTTPS dans Docker

.DESCRIPTION
    Diagnostique les problèmes HTTPS et propose des solutions

.EXAMPLE
    .\Diagnose-HTTPS-Issue.ps1

.NOTES
    Version: 1.0
    Auteur: GitHub Copilot
    Date: 2024
#>

Write-Host "`n??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?  DIAGNOSTIC HTTPS - Kafka Producer API Docker                             ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan

# ============================================
# TEST 1: Docker Container Status
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "TEST 1: État du Conteneur Docker" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

$containerStatus = docker ps | Select-String "kafka-producer-test"
if ($containerStatus) {
    Write-Host "? Conteneur en cours d'exécution" -ForegroundColor Green
    Write-Host "   $containerStatus" -ForegroundColor Cyan
}
else {
    Write-Host "? Conteneur n'est pas en cours d'exécution" -ForegroundColor Red
    Write-Host "   Essayez: docker run -d --name kafka-producer-test -p 5000:80 -p 5001:443 kafka-producer:latest" -ForegroundColor Yellow
    exit 1
}

# ============================================
# TEST 2: HTTP (Port 5000)
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "TEST 2: HTTP (Port 5000)" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

try {
    $response = Invoke-WebRequest -Uri "http://localhost:5000/health" -TimeoutSec 3 -ErrorAction Stop
    Write-Host "? HTTP fonctionne!" -ForegroundColor Green
    Write-Host "   Status: $($response.StatusCode)" -ForegroundColor Cyan
    Write-Host "   Response: $($response.Content)" -ForegroundColor Cyan
}
catch {
    Write-Host "? HTTP ne répond pas" -ForegroundColor Red
    Write-Host "   Error: $($_.Exception.Message)" -ForegroundColor Yellow
}

# ============================================
# TEST 3: HTTPS avec SkipCertificateCheck
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "TEST 3: HTTPS avec SkipCertificateCheck" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

try {
    $response = Invoke-WebRequest -Uri "https://localhost:5001/health" `
        -TimeoutSec 3 `
        -SkipCertificateCheck `
        -ErrorAction Stop
    
    Write-Host "? HTTPS fonctionne!" -ForegroundColor Green
    Write-Host "   Status: $($response.StatusCode)" -ForegroundColor Cyan
    Write-Host "   Response: $($response.Content)" -ForegroundColor Cyan
}
catch {
    Write-Host "? HTTPS ne répond pas" -ForegroundColor Red
    Write-Host "   Error: $($_.Exception.Message)" -ForegroundColor Yellow
}

# ============================================
# TEST 4: Vérifier les certificats dans le conteneur
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "TEST 4: Certificats dans le Conteneur" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

$certCheck = docker exec kafka-producer-test ls -la /https/ 2>&1
if ($certCheck -match "aspnetapp.pfx") {
    Write-Host "? Certificat trouvé dans le conteneur" -ForegroundColor Green
    Write-Host "   $certCheck" -ForegroundColor Cyan
}
else {
    Write-Host "? Certificat manquant dans le conteneur" -ForegroundColor Red
}

# ============================================
# TEST 5: Logs du conteneur
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "TEST 5: Logs du Conteneur" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

$logs = docker logs kafka-producer-test --tail 30
Write-Host "Derniers logs:" -ForegroundColor Cyan
Write-Host $logs -ForegroundColor Gray

if ($logs -match "Application started") {
    Write-Host "? Application a démarré correctement" -ForegroundColor Green
}
else {
    Write-Host "??  Vérifiez les logs pour les erreurs" -ForegroundColor Yellow
}

# ============================================
# TEST 6: Vérifier les ports
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "TEST 6: Ports en Écoute" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

$ports = netstat -ano | Select-String "5000|5001"
if ($ports) {
    Write-Host "? Ports en écoute:" -ForegroundColor Green
    $ports | ForEach-Object { Write-Host "   $_" -ForegroundColor Cyan }
}
else {
    Write-Host "? Ports ne sont pas en écoute" -ForegroundColor Red
}

# ============================================
# RECOMMENDATIONS
# ============================================

Write-Host "`n??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Magenta
Write-Host "?  SOLUTIONS RECOMMANDÉES                                                    ?" -ForegroundColor Magenta
Write-Host "??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Magenta

Write-Host "`n?? Si HTTP (port 5000) fonctionne mais HTTPS (5001) ne fonctionne pas:" -ForegroundColor Yellow
Write-Host "   ? C'est NORMAL pour le développement" -ForegroundColor Cyan
Write-Host "   ? Utilisez: http://localhost:5000/health" -ForegroundColor Cyan

Write-Host "`n?? Solution 1: Désactiver HTTPS en développement" -ForegroundColor Yellow
Write-Host "   ? Modifier Program.cs: app.UseHttpsRedirection() ? // app.UseHttpsRedirection()" -ForegroundColor Cyan
Write-Host "   ? Ou définir: ASPNETCORE_URLS=http://+:80" -ForegroundColor Cyan

Write-Host "`n?? Solution 2: Utiliser HTTP et Swagger" -ForegroundColor Yellow
Write-Host "   ? Ouvrir: http://localhost:5000/swagger/ui/index.html" -ForegroundColor Cyan

Write-Host "`n?? Solution 3: Utiliser curl avec SkipCertificateCheck" -ForegroundColor Yellow
Write-Host "   ? Commande: `curl https://localhost:5001/health -SkipCertificateCheck`" -ForegroundColor Cyan

Write-Host "`n?? Solution 4: Recréer le conteneur sans HTTPS" -ForegroundColor Yellow

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "Quelle solution voulez-vous appliquer?" -ForegroundColor Cyan
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

Write-Host "`n1. Continuer avec HTTP (recommandé pour le dev)" -ForegroundColor Green
Write-Host "2. Recréer le conteneur sans HTTPS" -ForegroundColor Yellow
Write-Host "3. Afficher uniquement les diagnostics" -ForegroundColor Gray

$choice = Read-Host "`nChoisissez (1, 2, ou 3)"

switch ($choice) {
    "1" {
        Write-Host "`n? Utilisation en HTTP" -ForegroundColor Green
        Write-Host "   Health: http://localhost:5000/health" -ForegroundColor Cyan
        Write-Host "   Swagger: http://localhost:5000/swagger/ui/index.html" -ForegroundColor Cyan
        Write-Host "`n   Testez avec:" -ForegroundColor Yellow
        Write-Host "   curl http://localhost:5000/health" -ForegroundColor Gray
        Write-Host "   Start-Process http://localhost:5000/swagger/ui/index.html" -ForegroundColor Gray
    }
    "2" {
        Write-Host "`n?? Recréation du conteneur sans HTTPS..." -ForegroundColor Yellow
        
        Write-Host "`n1. Arrêt du conteneur..." -ForegroundColor Cyan
        docker stop kafka-producer-test 2>&1 | Out-Null
        docker rm kafka-producer-test 2>&1 | Out-Null
        
        Write-Host "2. Modification du Dockerfile (HTTP uniquement)..." -ForegroundColor Cyan
        
        # Créer un Dockerfile sans HTTPS
        $httpsOnlyDockerfile = @"
# Multi-stage Dockerfile - HTTP Only (Development)

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS builder
WORKDIR /source
COPY ["kafka_producer.csproj", ""]
COPY ["Program.cs", ""]
COPY ["appsettings.json", ""]
COPY ["appsettings.Development.json", ""]
COPY ["Services/", "Services/"]
COPY ["Controllers/", "Controllers/"]
COPY ["Properties/", "Properties/"]
RUN dotnet restore "kafka_producer.csproj"
RUN dotnet build "kafka_producer.csproj" -c Release -o /app/build
RUN dotnet publish "kafka_producer.csproj" -c Release -o /app/publish /p:UseAppHost=false

FROM mcr.microsoft.com/dotnet/aspnet:8.0
WORKDIR /app
RUN apt-get update && apt-get install -y curl ca-certificates && rm -rf /var/lib/apt/lists/*
COPY --from=builder /app/publish .
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 CMD curl -f http://localhost:80/health || exit 1
EXPOSE 80
ENV ASPNETCORE_ENVIRONMENT=Development
ENV ASPNETCORE_URLS=http://+:80
ENTRYPOINT ["dotnet", "kafka_producer.dll"]
"@
        
        $httpsOnlyDockerfile | Out-File -FilePath "Dockerfile.http-only" -Encoding UTF8
        
        Write-Host "3. Build de l'image sans HTTPS..." -ForegroundColor Cyan
        docker build -f Dockerfile.http-only -t kafka-producer:http-only . | Out-Null
        
        Write-Host "4. Lancement du conteneur..." -ForegroundColor Cyan
        docker run -d --name kafka-producer-test -p 5000:80 kafka-producer:http-only | Out-Null
        
        Write-Host "5. Attente du démarrage..." -ForegroundColor Cyan
        Start-Sleep -Seconds 5
        
        Write-Host "`n? Conteneur lancé en HTTP uniquement" -ForegroundColor Green
        Write-Host "   Health: http://localhost:5000/health" -ForegroundColor Cyan
        Write-Host "   Swagger: http://localhost:5000/swagger/ui/index.html" -ForegroundColor Cyan
        
        # Test rapide
        try {
            $response = Invoke-WebRequest -Uri "http://localhost:5000/health" -TimeoutSec 3 -ErrorAction Stop
            Write-Host "`n? API répond: $($response.Content)" -ForegroundColor Green
        }
        catch {
            Write-Host "`n??  API ne répond pas encore, attendez 10 secondes..." -ForegroundColor Yellow
            Start-Sleep -Seconds 10
        }
    }
    "3" {
        Write-Host "`n?? Diagnostic terminé" -ForegroundColor Cyan
    }
}

Write-Host "`n??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host "?  DIAGNOSTIC TERMINÉ                                                        ?" -ForegroundColor Green
Write-Host "??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Green

Write-Host "`n?? Prochaines étapes:" -ForegroundColor Cyan
Write-Host "   1. Testez l'API avec curl ou navigateur" -ForegroundColor Gray
Write-Host "   2. Consultez les logs: docker logs -f kafka-producer-test" -ForegroundColor Gray
Write-Host "   3. Accédez à Swagger UI" -ForegroundColor Gray

Write-Host "`n"
