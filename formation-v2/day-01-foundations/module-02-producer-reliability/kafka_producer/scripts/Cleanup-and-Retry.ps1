# Cleanup-and-Retry.ps1 - Nettoyage et Relancement des Tests Docker

<#
.SYNOPSIS
    Script de nettoyage et relancement complet des tests Docker

.DESCRIPTION
    Ce script:
    1. Arrête tous les conteneurs Docker
    2. Supprime les conteneurs et images
    3. Recompile l'image avec le nouveau Dockerfile
    4. Relance les tests
    5. Génère un rapport

.EXAMPLE
    .\Cleanup-and-Retry.ps1

.NOTES
    Version: 1.0
    Auteur: GitHub Copilot
    Date: 2024
#>

Write-Host "`n" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Magenta
Write-Host "?  DOCKER CLEANUP & RETRY - Kafka Producer API                              ?" -ForegroundColor Magenta
Write-Host "??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Magenta

Write-Host "`n??  Cette action va:" -ForegroundColor Yellow
Write-Host "   1. Arrêter tous les conteneurs Docker" -ForegroundColor Cyan
Write-Host "   2. Supprimer les conteneurs existants" -ForegroundColor Cyan
Write-Host "   3. Supprimer les anciennes images" -ForegroundColor Cyan
Write-Host "   4. Nettoyer le cache Docker" -ForegroundColor Cyan
Write-Host "   5. Compiler une nouvelle image" -ForegroundColor Cyan
Write-Host "   6. Relancer les tests" -ForegroundColor Cyan

$confirm = Read-Host "`nVoulez-vous continuer? (oui/non)"
if ($confirm -ne "oui") {
    Write-Host "Opération annulée." -ForegroundColor Yellow
    exit 0
}

Write-Host "`n" -ForegroundColor Cyan

# ============================================
# ÉTAPE 1: Arrêter tous les conteneurs
# ============================================

Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "ÉTAPE 1: Arrêt des Conteneurs" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

try {
    Write-Host "  ??  Arrêt de tous les conteneurs en cours d'exécution..." -ForegroundColor Cyan
    
    $runningContainers = docker ps -q
    if ($runningContainers) {
        docker stop $runningContainers | Out-Null
        Write-Host "  ? Conteneurs arrêtés" -ForegroundColor Green
    }
    else {
        Write-Host "  ??  Aucun conteneur en cours d'exécution" -ForegroundColor Cyan
    }
}
catch {
    Write-Host "  ??  Erreur lors de l'arrêt: $_" -ForegroundColor Yellow
}

# ============================================
# ÉTAPE 2: Supprimer les conteneurs
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "ÉTAPE 2: Suppression des Conteneurs" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

try {
    Write-Host "  ??  Suppression du conteneur 'kafka-producer-test'..." -ForegroundColor Cyan
    docker rm kafka-producer-test -f 2>&1 | Out-Null
    Write-Host "  ? Conteneur supprimé" -ForegroundColor Green
}
catch {
    Write-Host "  ??  Conteneur n'existait pas (normal)" -ForegroundColor Cyan
}

# ============================================
# ÉTAPE 3: Supprimer les images
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "ÉTAPE 3: Suppression des Images Docker" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

try {
    Write-Host "  ??  Suppression de l'image 'kafka-producer'..." -ForegroundColor Cyan
    docker rmi kafka-producer:latest -f 2>&1 | Out-Null
    Write-Host "  ? Image supprimée" -ForegroundColor Green
}
catch {
    Write-Host "  ??  Image n'existait pas (normal)" -ForegroundColor Cyan
}

# ============================================
# ÉTAPE 4: Nettoyer le cache Docker
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "ÉTAPE 4: Nettoyage du Cache Docker" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

Write-Host "  ??  Nettoyage du cache build..." -ForegroundColor Cyan
docker builder prune -a -f --filter "until=2h" 2>&1 | Out-Null
Write-Host "  ? Cache nettoyé" -ForegroundColor Green

# ============================================
# ÉTAPE 5: Afficher les statistiques
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "ÉTAPE 5: Statistiques Actuelles" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

Write-Host "`n  ?? Images Docker:" -ForegroundColor Cyan
$images = docker images | Select-Object -Skip 1
if ($images) {
    $images | ForEach-Object { Write-Host "     $_" -ForegroundColor Gray }
}
else {
    Write-Host "     (Aucune image)" -ForegroundColor Gray
}

Write-Host "`n  ?? Conteneurs Docker:" -ForegroundColor Cyan
$containers = docker ps -a
if ($containers.Count -gt 1) {
    $containers | Select-Object -Skip 1 | ForEach-Object { Write-Host "     $_" -ForegroundColor Gray }
}
else {
    Write-Host "     (Aucun conteneur)" -ForegroundColor Gray
}

# ============================================
# ÉTAPE 6: Relancer les tests
# ============================================

Write-Host "`n?????????????????????????????????????????????????????" -ForegroundColor Gray
Write-Host "ÉTAPE 6: Relancement des Tests Docker" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????" -ForegroundColor Gray

Write-Host "`n  ??  Exécution de Full-Docker-Check.ps1..." -ForegroundColor Cyan
Write-Host "  (Le nouveau Dockerfile avec les certificats HTTPS sera utilisé)" -ForegroundColor Cyan

# Exécuter le script de test
& .\Full-Docker-Check.ps1

Write-Host "`n" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host "?  ? CLEANUP ET RETRY TERMINÉS                                             ?" -ForegroundColor Green
Write-Host "??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Green

Write-Host "`n?? Prochaines étapes:" -ForegroundColor Cyan
Write-Host "   1. Consultez le rapport généré" -ForegroundColor Gray
Write-Host "   2. Accédez à: http://localhost:5000/health (HTTP)" -ForegroundColor Gray
Write-Host "   3. Accédez à: https://localhost:5001/swagger/ui/index.html (HTTPS)" -ForegroundColor Gray
Write-Host "   4. Consultez les logs: docker logs -f kafka-producer-test" -ForegroundColor Gray

Write-Host "`n"
